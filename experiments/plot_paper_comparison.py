"""
Plot Paper Comparison
=====================

Generates plots mirroring Figures 11-15 from Li et al. (2015) using
the validation data generated by paper_validation.py.

This allows for side-by-side comparison between the paper's reported values
and our simulation results.
"""

import pandas as pd
import matplotlib.pyplot as plt
import os
import numpy as np

def setup_style():
    """Set up plotting style to match academic papers"""
    plt.style.use('seaborn-v0_8-whitegrid')
    plt.rcParams['font.family'] = 'serif'
    plt.rcParams['font.serif'] = ['Times New Roman', 'DejaVu Serif']
    plt.rcParams['axes.labelsize'] = 12
    plt.rcParams['axes.titlesize'] = 14
    plt.rcParams['xtick.labelsize'] = 10
    plt.rcParams['ytick.labelsize'] = 10
    plt.rcParams['legend.fontsize'] = 11
    plt.rcParams['lines.linewidth'] = 2
    plt.rcParams['lines.markersize'] = 8

def plot_figure_11():
    """
    Figure 11: Mean Delivery Time vs Number of Threads
    """
    print("Generating Figure 11 plot...")
    try:
        df = pd.read_csv('results/data/figure11_delivery_time.csv')
    except FileNotFoundError:
        print("  Error: Data file not found.")
        return

    fig, ax = plt.subplots(figsize=(8, 6))

    # Plot for q=99%
    df_99 = df[df['reliability'] == 'q_99%']
    ax.plot(df_99['n_threads'], df_99['paper_mean_delivery'], 'b--s', label='Paper (q=99%)', alpha=0.7)
    
    if 'ci_95' in df_99.columns:
        ax.errorbar(df_99['n_threads'], df_99['our_simulated'], yerr=df_99['ci_95'], 
                   fmt='b-o', label='Our Sim (q=99%)', capsize=4)
    else:
        ax.plot(df_99['n_threads'], df_99['our_simulated'], 'b-o', label='Our Sim (q=99%)')

    # Plot for q=88%
    df_88 = df[df['reliability'] == 'q_88%']
    ax.plot(df_88['n_threads'], df_88['paper_mean_delivery'], 'r--s', label='Paper (q=88%)', alpha=0.7)
    
    if 'ci_95' in df_88.columns:
        ax.errorbar(df_88['n_threads'], df_88['our_simulated'], yerr=df_88['ci_95'], 
                   fmt='r-o', label='Our Sim (q=88%)', capsize=4)
    else:
        ax.plot(df_88['n_threads'], df_88['our_simulated'], 'r-o', label='Our Sim (q=88%)')

    ax.set_xlabel('Number of Threads (n)')
    ax.set_ylabel('Mean Delivery Time (s)')
    ax.set_title('Figure 11: Mean Delivery Time vs Threads')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.6)
    
    plt.tight_layout()
    plt.savefig('results/plots/figure11_comparison.png', dpi=300)
    print("  Saved results/plots/figure11_comparison.png")

def plot_figure_12():
    """
    Figure 12: Queue Length vs Number of Threads
    """
    print("Generating Figure 12 plot...")
    try:
        df = pd.read_csv('results/data/figure12_queue_length.csv')
    except FileNotFoundError:
        print("  Error: Data file not found.")
        return

    fig, ax = plt.subplots(figsize=(8, 6))

    ax.plot(df['n_threads'], df['paper_queue_length'], 'k--s', label='Paper (q=99%)', alpha=0.7)
    ax.plot(df['n_threads'], df['our_queue_length'], 'k-o', label='Our Sim (q=99%)')

    ax.set_xlabel('Number of Threads (n)')
    ax.set_ylabel('Mean Queue Length')
    ax.set_title('Figure 12: Queue Length vs Threads')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.6)
    
    plt.tight_layout()
    plt.savefig('results/plots/figure12_comparison.png', dpi=300)
    print("  Saved results/plots/figure12_comparison.png")

def plot_figure_13():
    """
    Figure 13: Component Utilization vs Number of Threads
    """
    print("Generating Figure 13 plot...")
    try:
        df = pd.read_csv('results/data/figure13_utilization.csv')
    except FileNotFoundError:
        print("  Error: Data file not found.")
        return

    fig, ax = plt.subplots(figsize=(8, 6))

    # Only plotting q=99% for clarity, similar to paper's likely focus
    df_99 = df[df['reliability'] == 'q_99%']

    ax.plot(df_99['n_threads'], df_99['paper_sender_util'], 'g--s', label='Paper Sender', alpha=0.7)
    ax.plot(df_99['n_threads'], df_99['our_sender_util'], 'g-o', label='Our Sender')
    
    ax.plot(df_99['n_threads'], df_99['paper_broker_util'], 'm--^', label='Paper Broker', alpha=0.7)
    ax.plot(df_99['n_threads'], df_99['our_broker_util'], 'm-v', label='Our Broker')

    ax.set_xlabel('Number of Threads (n)')
    ax.set_ylabel('Utilization (œÅ)')
    ax.set_title('Figure 13: Utilization vs Threads (q=99%)')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.6)
    
    plt.tight_layout()
    plt.savefig('results/plots/figure13_comparison.png', dpi=300)
    print("  Saved results/plots/figure13_comparison.png")

def plot_figure_14():
    """
    Figure 14: Performance vs Service Time
    """
    print("Generating Figure 14 plot...")
    try:
        df = pd.read_csv('results/data/figure14_service_time.csv')
    except FileNotFoundError:
        print("  Error: Data file not found.")
        return

    fig, ax = plt.subplots(figsize=(8, 6))

    # Plot delivery time for different n values
    for n in sorted(df['n_threads'].unique()):
        subset = df[df['n_threads'] == n]
        ax.plot(subset['service_time_ms'], subset['mean_delivery_time'], 'o-', label=f'n={n}')

    ax.set_xlabel('Service Time (ms)')
    ax.set_ylabel('Mean Delivery Time (s)')
    ax.set_title('Figure 14: Delivery Time vs Service Time')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.6)
    
    plt.tight_layout()
    plt.savefig('results/plots/figure14_reproduction.png', dpi=300)
    print("  Saved results/plots/figure14_reproduction.png")

def plot_figure_15():
    """
    Figure 15: Performance vs Arrival Rate
    """
    print("Generating Figure 15 plot...")
    try:
        df = pd.read_csv('results/data/figure15_arrival_rate.csv')
    except FileNotFoundError:
        print("  Error: Data file not found.")
        return

    fig, ax = plt.subplots(figsize=(8, 6))

    # Plot delivery time for different n values
    for n in sorted(df['n_threads'].unique()):
        subset = df[df['n_threads'] == n]
        ax.plot(subset['arrival_rate'], subset['mean_delivery_time'], 'o-', label=f'n={n}')

    ax.set_xlabel('Arrival Rate (msg/s)')
    ax.set_ylabel('Mean Delivery Time (s)')
    ax.set_title('Figure 15: Delivery Time vs Arrival Rate')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.6)
    
    plt.tight_layout()
    plt.savefig('results/plots/figure15_reproduction.png', dpi=300)
    print("  Saved results/plots/figure15_reproduction.png")

def main():
    os.makedirs('results/plots', exist_ok=True)
    setup_style()
    
    plot_figure_11()
    plot_figure_12()
    plot_figure_13()
    plot_figure_14()
    plot_figure_15()
    
    print("\nPaper comparison plots generated successfully!")

if __name__ == "__main__":
    main()
